# **ì„¤ì • ê¸°ë°˜ ë™ì  í¬ë¡¤ëŸ¬ ë¶„ì„ ë° êµ¬í˜„ ê°€ì´ë“œ**

## **1ë¶€: ì‹ ê·œ í¬ë¡¤ë§ íƒ€ê²Ÿ ë¶„ì„ ê°€ì´ë“œ**

### **ğŸš€ Step 0: ê°€ì´ë“œ ê°œìš”**

ë³¸ ë¬¸ì„œëŠ” ì‹ ê·œ ì›¹ì‚¬ì´íŠ¸ë¥¼ í¬ë¡¤ë§ ëŒ€ìƒì— ì¶”ê°€í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ì •ì˜í•˜ëŠ” ê³¼ì •ì„ ì•ˆë‚´í•©ë‹ˆë‹¤. ì„±ê³µì ì¸ í¬ë¡¤ëŸ¬ ê°œë°œì€ ë‹¨ìˆœíˆ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œë§Œìœ¼ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•Šìœ¼ë©°, ê° ì‚¬ì´íŠ¸ì˜ ê³ ìœ í•œ êµ¬ì¡°ì™€ ì •ì±…ì„ ì´í•´í•˜ê³  ì´ë¥¼ ê¸°ê³„ê°€ ì½ì„ ìˆ˜ ìˆëŠ” \*\*'ì„¤ì •(Configuration)'\*\*ìœ¼ë¡œ ë§Œë“œëŠ” ì²´ê³„ì ì¸ ë¶„ì„ì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.

---

### **ğŸ¯ Step 1: íƒ€ê²Ÿ ì‹ë³„ ë° ê¸°ë³¸ ë©”íƒ€ë°ì´í„° ì •ì˜**

> **ëª©í‘œ**: í¬ë¡¤ë§í•  ëŒ€ìƒì´ ë¬´ì—‡ì¸ì§€ ëª…í™•íˆ í•˜ê³ , ì‹œìŠ¤í…œì—ì„œ ê´€ë¦¬í•  ê¸°ë³¸ ì •ë³´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

- **1.1. ì‚¬ì´íŠ¸ ì´ë¦„ (Store Name)**

  - ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•  ê³ ìœ í•œ ì´ë¦„ì…ë‹ˆë‹¤.
  - **ì˜ˆì‹œ**: `ë² ì´í”„ë ˆì†Œ ê³µì‹ëª°`

- **1.2. ê¸°ë³¸ URL (Base URL)**

  - ì‚¬ì´íŠ¸ì˜ ë©”ì¸ ë„ë©”ì¸ ì£¼ì†Œì…ë‹ˆë‹¤.
  - **ì˜ˆì‹œ**: `https://www.vaporesso.com`

- **1.3. í¬ë¡¤ë§ ì‹œì‘ì  URL (Entry Point URL)**

  - í¬ë¡¤ëŸ¬ê°€ ìƒí’ˆ ëª©ë¡ íƒìƒ‰ì„ ì‹œì‘í•  í˜ì´ì§€ì˜ ì „ì²´ ì£¼ì†Œì…ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ê°€ ì—¬ëŸ¬ ê°œì¼ ê²½ìš° ì—¬ëŸ¬ ê°œë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - **ì˜ˆì‹œ**: `https://www.vaporesso.com/vape-kits`

---

### **ğŸ—ºï¸ Step 2: ë„¤ë¹„ê²Œì´ì…˜ ë° ìƒí’ˆ íƒìƒ‰ ì „ëµ ìˆ˜ë¦½**

> **ëª©í‘œ**: ì‚¬ì´íŠ¸ì˜ ëª¨ë“  ìƒí’ˆ í˜ì´ì§€ì— ë„ë‹¬í•˜ê¸° ìœ„í•œ ê²½ë¡œ íƒìƒ‰ ë°©ë²•ì„ ì •ì˜í•©ë‹ˆë‹¤.

#### **2.1. ìƒí’ˆ ëª©ë¡ ì‹ë³„**

- **ìƒí’ˆ ì•„ì´í…œ ì„ íƒì (List Item Selector)**

  - ìƒí’ˆ ëª©ë¡ í˜ì´ì§€ì—ì„œ ê° ìƒí’ˆ í•˜ë‚˜í•˜ë‚˜ë¥¼ ê°ì‹¸ê³  ìˆëŠ” ë°˜ë³µë˜ëŠ” HTML ìš”ì†Œì˜ CSS ì„ íƒìì…ë‹ˆë‹¤.
  - **ì˜ˆì‹œ**: `div.product-item`

- **ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ë§í¬ ì„ íƒì (Detail Link Selector)**

  - ìœ„ì—ì„œ ì°¾ì€ 'ìƒí’ˆ ì•„ì´í…œ' ìš”ì†Œ ë‚´ì—ì„œ, ì‹¤ì œ ìƒì„¸ í˜ì´ì§€ë¡œ ì—°ê²°ë˜ëŠ” `<a>` íƒœê·¸ì˜ ì„ íƒìì…ë‹ˆë‹¤.
  - **ì˜ˆì‹œ**: `a.product-item-link`

#### **2.2. í˜ì´ì§€ë„¤ì´ì…˜(Pagination) ì „ëµ ì •ì˜**

- **ì „ëµ ìœ í˜• ì„ íƒ**:

  - **[ âœ“ ] ë²„íŠ¼ ê¸°ë°˜ (Button-based)**
  - **[ ] URL íŒ¨í„´ ê¸°ë°˜ (URL Pattern-based)**

- **ìƒì„¸ ì •ë³´**:

  - **(ë²„íŠ¼ ê¸°ë°˜ ì‹œ)** 'ë‹¤ìŒ í˜ì´ì§€'ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ì˜ CSS ì„ íƒì:
    - **ì˜ˆì‹œ**: `a.pagination-next`
  - **(URL íŒ¨í„´ ê¸°ë°˜ ì‹œ)** í˜ì´ì§€ ë²ˆí˜¸ê°€ í¬í•¨ëœ URLì˜ ê·œì¹™:
    - **ì˜ˆì‹œ**: `https://example.com/products?page={page_number}`

#### **2.3. ë™ì  ë¡œë”©(Dynamic Loading) ì²˜ë¦¬**

- **ì „ëµ ìœ í˜• ì„ íƒ**:

  - **[ ] 'ë”ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ('Load More' Button)**
  - **[ ] ë¬´í•œ ìŠ¤í¬ë¡¤ (Infinite Scroll)**
  - **[ âœ“ ] í•´ë‹¹ ì—†ìŒ (N/A)**

- **ìƒì„¸ ì •ë³´**:

  - **('ë”ë³´ê¸°' ë²„íŠ¼ ì‹œ)** ë”ë³´ê¸° ë²„íŠ¼ì˜ CSS ì„ íƒì: `button#load-more-btn`
  - **(ë¬´í•œ ìŠ¤í¬ë¡¤ ì‹œ)** ìŠ¤í¬ë¡¤ íšŸìˆ˜ ë˜ëŠ” ìŠ¤í¬ë¡¤ ì¢…ë£Œë¥¼ ê°ì§€í•  ìš”ì†Œì˜ ì„ íƒì: `div#scroll-end-detector`

---

### **ğŸ› ï¸ Step 3: ìƒì„¸ í˜ì´ì§€ ë°ì´í„° ì¶”ì¶œ ê·œì¹™ ì •ì˜**

> **ëª©í‘œ**: ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ì—ì„œ ìš°ë¦¬ê°€ ìˆ˜ì§‘í•˜ê³ ì í•˜ëŠ” ê° ë°ì´í„° í•„ë“œì˜ ì •í™•í•œ ìœ„ì¹˜(CSS ì„ íƒì)ì™€ ì¶”ì¶œ ë°©ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.

| ë°ì´í„° í•„ë“œ        | CSS ì„ íƒì                           | ì¶”ì¶œ ë°©ì‹ (`text` ë˜ëŠ” `attribute:ì†ì„±ëª…`) | ë¹„ê³  (ì˜µì…˜ ì„ íƒ ë“± íŠ¹ì´ì‚¬í•­)             |
| :----------------- | :----------------------------------- | :----------------------------------------- | :--------------------------------------- |
| **ìƒí’ˆëª…**         | `h1.product-title`                   | `text`                                     |                                          |
| **ê°€ê²©**           | `span.price`                         | `text`                                     | ìˆ«ì ì™¸ í†µí™” ê¸°í˜¸, ì‰¼í‘œ ì œê±° í•„ìš”        |
| **ì´ë¯¸ì§€ URL**     | `div.product-gallery img.main-image` | `attribute:src`                            |                                          |
| **ì¬ê³  ìƒíƒœ**      | `div.stock-status`                   | `text`                                     | "ì¬ê³  ìˆìŒ", "í’ˆì ˆ" ë“±ì˜ í…ìŠ¤íŠ¸          |
| **ìƒí’ˆ ì½”ë“œ(SKU)** | `span.sku-code`                      | `text`                                     |                                          |
| **ìƒì„¸ ì„¤ëª…**      | `div#product-description`            | `html`                                     | HTML íƒœê·¸ ì „ì²´ë¥¼ ì €ì¥                    |
| **ì˜µì…˜ ë²„íŠ¼**      | `button.option-select`               | N/A                                        | ê°€ê²©/ì¬ê³  ë³€ê²½ì„ ìœ„í•´ í´ë¦­ì´ í•„ìš”í•œ ë²„íŠ¼ |

---

### **âš™ï¸ Step 4: í¬ë¡¤ëŸ¬ ë™ì‘ ë° ì •ì±… ì„¤ì •**

> **ëª©í‘œ**: ëŒ€ìƒ ì„œë²„ì— ë¶€ë‹´ì„ ì£¼ì§€ ì•Šê³ , ì°¨ë‹¨ì„ íšŒí”¼í•˜ê¸° ìœ„í•œ í¬ë¡¤ëŸ¬ì˜ í–‰ë™ ê·œì¹™ì„ ì„¤ì •í•©ë‹ˆë‹¤.

- **4.1. ìš”ì²­ ê°„ ë”œë ˆì´ (Request Delay)**

  - ê° í˜ì´ì§€ ìš”ì²­ ì‚¬ì´ì˜ ìµœì†Œ ëŒ€ê¸° ì‹œê°„ (ë°€ë¦¬ì´ˆ ë‹¨ìœ„).
  - **ê°’**: `1500` (1.5ì´ˆ)

- **4.2. User-Agent**

  - ì„œë²„ì— ì „ì†¡í•  ë¸Œë¼ìš°ì € ì‹ë³„ ì •ë³´.
  - **ê°’**: `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36`

- **4.3. í”„ë¡ì‹œ ì‚¬ìš© ì—¬ë¶€ (Use Proxy)**

  - IP ê¸°ë°˜ ì°¨ë‹¨ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ í”„ë¡ì‹œ ì„œë²„ë¥¼ ì‚¬ìš©í• ì§€ ì—¬ë¶€.
  - **ê°’**: `ì•„ë‹ˆìš” (No)`

---

## **2ë¶€: ì„¤ì • ê¸°ë°˜ ë™ì  í¬ë¡¤ëŸ¬ êµ¬í˜„ ì˜ˆì‹œ**

> **ëª©í‘œ**: 1ë¶€ì—ì„œ ë¶„ì„í•˜ê³  ì •ì˜í•œ \*\*ì„¤ì •(JSON)\*\*ì„ ì´ìš©í•˜ì—¬, ì‹¤ì œë¡œ ë™ì‘í•˜ëŠ” ë™ì  í¬ë¡¤ëŸ¬ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

### **âœ¨ Step 1: í”„ë¡œì íŠ¸ êµ¬ì¡° ë° ì„¤ì • íŒŒì¼**

ì•„ë˜ì™€ ê°™ì€ ê°„ë‹¨í•œ í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ ê°€ì •í•©ë‹ˆë‹¤.

```
/dynamic-crawler
â”œâ”€â”€ config.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ crawler.ts
â”‚   â””â”€â”€ server.ts
â””â”€â”€ package.json
```

#### **`config.json`**

1ë¶€ì˜ ìµœì¢… ê²°ê³¼ë¬¼ì¸ ì„¤ì • íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ì €ì¥í•©ë‹ˆë‹¤. í¬ë¡¤ëŸ¬ëŠ” ì´ íŒŒì¼ì„ ì½ì–´ ë™ì‘í•©ë‹ˆë‹¤.

```json
{
  "store_id": "vaporesso_official",
  "store_name": "ë² ì´í”„ë ˆì†Œ ê³µì‹ëª°",
  "base_url": "https://www.vaporesso.com",
  "entry_point_url": "https://www.vaporesso.com/vape-kits",
  "strategy": {
    "list_item_selector": "div.product-item",
    "detail_link_selector": "a.product-item-link",
    "pagination": {
      "type": "button",
      "selector": "a.pagination-next"
    }
  },
  "selectors": {
    "product_name": { "selector": "h1.product-title", "type": "text" },
    "price": { "selector": "span.price", "type": "text" },
    "image_url": {
      "selector": "div.product-gallery img.main-image",
      "type": "attribute:src"
    }
  },
  "policy": {
    "request_delay_ms": 1500
  }
}
```

---

### **âœ¨ Step 2: ë™ì  í¬ë¡¤ëŸ¬ ë¡œì§ êµ¬í˜„**

#### **`src/crawler.ts`**

ì´ íŒŒì¼ì€ `config.json` íŒŒì¼ì„ ì¸ìë¡œ ë°›ì•„ ì‹¤ì œ Playwright í¬ë¡¤ë§ì„ ìˆ˜í–‰í•˜ëŠ” í•µì‹¬ ë¡œì§ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

```typescript
import { chromium, Browser, Page } from 'playwright';

// config.jsonì˜ íƒ€ì…ì„ ì •ì˜í•©ë‹ˆë‹¤.
// ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë” ìƒì„¸í•˜ê²Œ íƒ€ì…ì„ ì •ì˜í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
type CrawlConfig = any;

// í•˜ë‚˜ì˜ ìƒì„¸ í˜ì´ì§€ì—ì„œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
async function scrapeDetailPage(page: Page, config: CrawlConfig): Promise<any> {
  const results: { [key: string]: string | null } = {};

  for (const key in config.selectors) {
    const { selector, type } = config.selectors[key];
    const locator = page.locator(selector).first();

    try {
      if (type === 'text') {
        results[key] = await locator.textContent();
      } else if (type.startsWith('attribute:')) {
        const attributeName = type.split(':')[1];
        results[key] = await locator.getAttribute(attributeName);
      }
    } catch (error) {
      console.error(
        `Error extracting ${key} with selector ${selector}:`,
        error,
      );
      results[key] = null;
    }
  }
  return results;
}

export async function executeCrawl(config: CrawlConfig) {
  console.log(`[${config.store_name}] í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...`);
  const browser = await chromium.launch({ headless: true });
  const context = await browser.newContext();
  const page = await context.newPage();

  await page.goto(config.entry_point_url);
  console.log(`- ì‹œì‘ í˜ì´ì§€ë¡œ ì´ë™: ${config.entry_point_url}`);

  let hasNextPage = true;
  let pageNum = 1;

  while (hasNextPage) {
    console.log(`\n- ${pageNum} í˜ì´ì§€ ì²˜ë¦¬ ì¤‘...`);

    const productItems = await page
      .locator(config.strategy.list_item_selector)
      .all();
    console.log(`  - ${productItems.length}ê°œì˜ ìƒí’ˆì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);

    for (const item of productItems) {
      const detailLink = await item
        .locator(config.strategy.detail_link_selector)
        .getAttribute('href');
      if (detailLink) {
        const detailPage = await context.newPage();
        await detailPage.goto(new URL(detailLink, config.base_url).href);

        const productData = await scrapeDetailPage(detailPage, config);
        console.log('    - ìˆ˜ì§‘ëœ ë°ì´í„°:', productData);

        await detailPage.close();
      }
      // ì •ì±…ì— ë”°ë¼ ë”œë ˆì´ë¥¼ ì¤ë‹ˆë‹¤.
      await page.waitForTimeout(config.policy.request_delay_ms);
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
    if (config.strategy.pagination.type === 'button') {
      const nextButton = page.locator(config.strategy.pagination.selector);
      if ((await nextButton.isVisible()) && (await nextButton.isEnabled())) {
        await nextButton.click();
        await page.waitForLoadState('domcontentloaded'); // í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
        pageNum++;
      } else {
        hasNextPage = false;
        console.log('\n- ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ì–´ í¬ë¡¤ë§ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
      }
    } else {
      hasNextPage = false; // ë‹¤ë¥¸ í˜ì´ì§€ë„¤ì´ì…˜ íƒ€ì…ì€ ì˜ˆì œì—ì„œ ìƒëµ
    }
  }

  await browser.close();
  console.log(`[${config.store_name}] í¬ë¡¤ë§ ì™„ë£Œ!`);
}
```

---

### **âœ¨ Step 3: API ì„œë²„ íŠ¸ë¦¬ê±° êµ¬í˜„**

#### **`src/server.ts`**

Fastifyë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ë¡¤ë§ì„ ì‹œì‘ì‹œí‚¤ëŠ” ê°„ë‹¨í•œ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.

```typescript
import Fastify from 'fastify';
import { executeCrawl } from './crawler';
import * as fs from 'fs/promises';
import * as path from 'path';

const fastify = Fastify({ logger: true });

fastify.post('/crawl', async (request, reply) => {
  try {
    // config.json íŒŒì¼ì„ ì½ì–´ì˜µë‹ˆë‹¤.
    const configPath = path.join(__dirname, '..', 'config.json');
    const configData = await fs.readFile(configPath, 'utf-8');
    const config = JSON.parse(configData);

    // í¬ë¡¤ë§ í•¨ìˆ˜ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
    // ì‹¤ì œ ìš´ì˜ ì‹œìŠ¤í…œì—ì„œëŠ” ì´ ë¶€ë¶„ì„ BullMQì™€ ê°™ì€ ì‘ì—… íì— ì‘ì—…ì„ ë“±ë¡í•˜ëŠ” ì½”ë“œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
    executeCrawl(config);

    // í¬ë¡¤ë§ì´ ì™„ë£Œë˜ëŠ” ê²ƒì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì¦‰ì‹œ ì‘ë‹µì„ ë³´ëƒ…ë‹ˆë‹¤.
    reply.send({
      status: 'success',
      message: 'Crawl started in the background.',
    });
  } catch (error) {
    fastify.log.error(error);
    reply
      .status(500)
      .send({ status: 'error', message: 'Failed to start crawl.' });
  }
});

const start = async () => {
  try {
    await fastify.listen({ port: 3000 });
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};

start();
```

---

### **âœ¨ Step 4: ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸**

1.  **ì˜ì¡´ì„± ì„¤ì¹˜**

    ```bash
    npm install fastify playwright typescript ts-node @types/node
    npx playwright install
    ```

2.  **API ì„œë²„ ì‹¤í–‰**

    ```bash
    npx ts-node src/server.ts
    ```

3.  **í¬ë¡¤ë§ íŠ¸ë¦¬ê±°** (ìƒˆ í„°ë¯¸ë„ì—ì„œ)

    ```bash
    curl -X POST http://localhost:3000/crawl
    ```

4.  **ê²°ê³¼ í™•ì¸**: API ì„œë²„ë¥¼ ì‹¤í–‰í•œ í„°ë¯¸ë„ì— `crawler.ts`ì—ì„œ ì‘ì„±í•œ ë¡œê·¸ê°€ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤.
